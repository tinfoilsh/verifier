name: Release

on:
  push:
    # tags:
    #   - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Set up gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          go get -u golang.org/x/mobile/bind

      - name: Build WASM
        run: |
          go mod download
          go run ./rootfetch/main.go -o client/trusted_root.json
          cp client/trusted_root.json wasm/
          VERSION=${GITHUB_REF#refs/tags/}
          cd wasm && GOOS=js GOARCH=wasm go build \
            -trimpath \
            -ldflags="-buildid= -X main.version=${VERSION}" \
            -o tinfoil-verifier-${VERSION}.wasm

      - name: Copy WASM to public folder
        run: |
          mkdir -p public
          cp wasm/tinfoil-verifier-*.wasm public/
          cp wasm/tinfoil-verifier-*.wasm public/tinfoil-verifier.wasm

      - name: gomobile bind
        run: |
          gomobile bind -target=ios,iossimulator,macos -o TinfoilVerifier.xcframework $(go list ./... | grep -v -E "/examples/|/rootfetch|/wasm" | xargs)
          zip -ry TinfoilVerifier.xcframework.zip TinfoilVerifier.xcframework

      # - name: Deploy to GH pages
      #   uses: JamesIves/github-pages-deploy-action@v4
      #   with:
      #     folder: public

      # - name: Release
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     files: |
      #       TinfoilVerifier.xcframework.zip
      #       wasm/tinfoil-verifier-*.wasm
